- name : configue shipping server
  hosts: shipping
  become : yes
  tasks: 
    - name: install maven
      ansible.builtin.dnf:
        name : "{{item}}"
        state : present
      loop: 
        - maven
        - mysql

    - name: useradd 
      ansible.builtin.user:
        name : roboshop
        system : true
        home : /app
        shell : /sbin/nologin
        comment : "roboshop system user"

    - name : delete directory
      ansible.builtin.file:
        path: /app
        state : absent
   

    - name: make directory
      ansible.builtin.file:
         path : /app
         state: directory

    - name : delete directory
      ansible.builtin.file:
        path: /tmp/shipping.zip
        state : absent

    - name : download the code
      ansible.builtin.get_url:
         url: https://roboshop-artifacts.s3.amazonaws.com/shipping-v3.zip 
         dest: /tmp/shipping.zip 

    - name: unzip the code
      ansible.builtin.unarchive:
           src: /tmp/shipping.zip
           dest: /app
           remote_src: yes

   

    - name: copy the shipping service
      ansible.builtin.template:
        src : shipping.service
        dest: /etc/systemd/system/shipping.service

    - name: deamon reload
      ansible.builtin.systemd_service:
        deamon_reload: true  

    - name: install dependencies
      ansible.builtin.pip: 
        name : "{{item}}"
        executable :  pip3.9
      loop: 
        - cryptography
        - PyMySQL

    - name: load the products
      community.mysql.mysql_db:
       state : import
       name: all
       login_host: "{{mysql_host}}"
       login_user: root
       login_password: Roboshop@1
       target: "{{item}}"
       loop:
         - /app/db/schema.sql
         - /app/db/app-user.sql 
         - /app/db/master-data.sql

    - name: restrat the service
      ansible.builtin.service:
        name: shipping
        state: restarted
        enabled : yes
        